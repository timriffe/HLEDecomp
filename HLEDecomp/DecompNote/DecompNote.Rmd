---
title: "Decomposition notes"
author: "Tim Riffe"
date: "May 21, 2019"
output: html_document
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Background

We have a 3 state discrete Markov model to estimate old-age life expectancy with and without disability. The states are disability-free (DF), disabled (Dis.) and dead. The transition probabilties are stratified by some strata, such as sex and three education levels. I'd like to decompose differences in expectancies over time or between groups into the contributions from these parameters. So far this is always using the pseudo-continuous method proposed by @horiuchi2008 .

# Inputs
This note will recycle the same parameters throughout: We have six vectors of transition probabilities for each of three education levels, and a radix with disability-free (DF) and disabled components for the three education levels (6-piece radix). 

```{r,echo=FALSE, message=FALSE }
library(data.table)
library(DemoDecomp)
library(RColorBrewer)
library(xtable)
library(compositions)
path <- "/home/tim/git/HLEDecomp/HLEDecomp"
source(file.path(path, "Code/R/Functions.R"))
TR    <- local(get(load(file.path(path, "Data/Transitions/DCS/initdetail/TR_v06.Rdata"))))
TR    <- data.table(TR)
# TR: had to fix colnames problem
PREV  <- TR[ , get_prev_dt(.SD), by = list(sex, edu, time)]
# TR2 just means that there are now TWO living states,
# healthy and disabled.
TR2   <- collapseTR(TR = TR, PREV = PREV)
setnames(TR2,c("m14","m24"),c("m13","m23"))
```

Here are those transition probabilities, hastily plotted. Black is survival + remaining in the state, green is mortality, and red is transferring to the other state. The education groups are not labelled but higher edu is better for each of the transition types. You can only sense subtle changes from 1996 to 2006, but these amount to a 1.48 year increase in DFLE, a trivial .03 year decrease in DLE, for an overall gain of 1.45 years in LE.
```{r, echo = FALSE}
a     <- seq(50, 110, by = 2)
cols  <- getcolsall(ntrans = 2)
cols1 <- cols[1:3]
cols2 <- cols[c(5,4,6)]

pri   <- TR2[time == 1996 & sex == "m" & edu == "primary"]
sec   <- TR2[time == 1996 & sex == "m" & edu == "secondary"]
ter   <- TR2[time == 1996 & sex == "m" & edu == "terciary"]

par(mfrow=c(2,2))
matplot(a,pri[,..cols1], type = 'l', xlab = "Age", ylab = "prob",las=1,ylim=c(0,1),
		main = "1996 DF origin")
matplot(a,sec[,..cols1], type = 'l', add = TRUE)
matplot(a,ter[,..cols1], type = 'l', add = TRUE)

matplot(a,pri[,..cols2], type = 'l', xlab = "Age", ylab = "prob",las=1,ylim=c(0,1),
		main = "1996 Dis. origin")
matplot(a,sec[,..cols2], type = 'l', add = TRUE)
matplot(a,ter[,..cols2], type = 'l', add = TRUE)

pri   <- TR2[time == 2006 & sex == "m" & edu == "primary"]
sec   <- TR2[time == 2006 & sex == "m" & edu == "secondary"]
ter   <- TR2[time == 2006 & sex == "m" & edu == "terciary"]

matplot(a,pri[,..cols1], type = 'l', xlab = "Age", ylab = "prob",las=1,ylim=c(0,1),
		main = "2006 DF origin")
matplot(a,sec[,..cols1], type = 'l', add = TRUE)
matplot(a,ter[,..cols1], type = 'l', add = TRUE)

matplot(a,pri[,..cols2], type = 'l', xlab = "Age", ylab = "prob",las=1,ylim=c(0,1),
		main = "2006 Dis. origin")
matplot(a,sec[,..cols2], type = 'l', add = TRUE)
matplot(a,ter[,..cols2], type = 'l', add = TRUE)
```

Also not to be left out, the starting composition changed some (dark is DF, light is Disabaled):
```{r, echo = FALSE}
sprop <- c("s1_prop","s2_prop")
radix1 <- as.matrix(TR2[time == 1996 & sex == "m" & age == 50,..sprop])
radix2 <- as.matrix(TR2[time == 2006 & sex == "m" & age == 50,..sprop])
rownames(radix1) <- rownames(radix2) <- c("pri","sec","ter")
par(mfrow=c(1,2))
barplot(t(radix1), main = "1996 male radix",ylim=c(0,.5),las=1)
barplot(t(radix2), main = "2006 male radix",ylim=c(0,.5),las=1)
```

# Decomposition approach
Assume that I have a function $f()$ that takes a single vector of parameters $\mathbf{\theta}$ and produces my desired expectancy (DFLE, DLE, or LE). $f(\mathbf{\theta})$ does all the book-keeping and arithmetic necessary to rearrange the the vector $\mathbf{\theta}$ into a transition matrix and estimate the desired expectancy, duly weighted by the radix composition, which is also contained in $\mathbf{\theta}$. 

**Horiuchi in a nutshell**:
Stacking the parameters into a single vector $\mathbf{\theta}$ sets up the decomposition easier. Horiuchi decomposition works like so: The vector $\mathbf{\theta}^{1996}$ gradually warps into $\mathbf{\theta}^{2006}$ along $N$ equispaced steps. At each of the $N$ steps, which can be thought of as the parameter background, each element of $\mathbf{\theta}$ is *independently* perturbed up and down by half a step, and the difference between these two values is taken as the contribution of the parameter given the background conditions. Each parameter ends up with $N$ such estimates, and their sum is taken to be the parameter contribution. Lo and behold the sum of these contributions of all the parameters is equal to $f(\mathbf{\theta}^{2006}) - f(\mathbf{\theta}^{1996})$

**Devil in the details**:
There are different ways to set up $f()$. The transition matrix created inside $f()$ only needs survivial and transfer probabilities. Mortality isn't in it. So $\mathbf{\theta}$ could contain just the black and red lines from the figure. But it could also be set up to take mortality and transfers, or survival and death but no transfers. In each of these three cases, the decomposition will run 

# Continuous time perspective
The continuous time representation of our multistate process can be expressed either as tuple of partial differential equations or as a continuous time Markov matrix, and examination of both cases will lead us to conclude that the only forces that matter in a multistate system are those of attrition.

### Continuous time matrices




### Differential equations

With states healthy $H$ and unhealthy $U$, and processes, $\mu^h$, $\mu^u$, $o^h$, and $r^u$ for mortality of healthy, unhealthy, onset of unhealthiness, and recovery from unhealthiness, respectively. Then we have two equations:
$$ \frac{\mathrm{d}H}{\mathrm{d}t} = -\mu^h H(t) - o^h H(t) + r^u U(t) ~\mathrm{d}t$$
$$ \frac{\mathrm{d}U}{\mathrm{d}t} = -\mu^u U(t) + o^h H(t) - r^u U(t) ~\mathrm{d}t$$
In this setup, the stocks $U$ and $H$ are determined only by the radix composition. Forces of survival and remaining in a state are not formally represented. Given continuous functions of these four rates of attrition, the entire process is a function of $U(0)$, $H(0)$ (the radix composition) and the four functions of rates of attrition. There is no compositional problem at all among the rates. 


# References

